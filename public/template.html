<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Reciept Manager</title>
    <link rel="stylesheet" href="main.css">
    <link rel="icon" href="Receipt-Icon.png">


  </head>
  <body>
        <header>
            <a class = "logo" href="https://receipthelpmanage.herokuapp.com"><img class = "MainImage" src="Receipt-Icon.png" alt = "logo"></a>
            <nav>
                <ul class="topbar">
                    <li>
                      <a class="UserIcon" id="DropDownIcon"><img id ="UserIconImage" class ="UserIconImage" src = "" alt = "img"></a>
                      <div class="DropDown" id="DropDown">
                        <a href="/logout" class ="DropDownItem" onclick="signOut()">
                          <img class="DropDownImage" src="Logout.png">
                          <div class= "DropDownText">Logout</div>
                        </a>
                      </div>
                      <script>
                        function signOut() {
                          var auth2 = gapi.auth2.getAuthInstance();
                          auth2.signOut().then(function () {
                            console.log('User signed out.');
                          });
                        }
                      </script>
                    </li>
                </ul>
            </nav>
        </header>

        <main>
          <div class="ContentContainer">

            <div class="NavigationReceipts">
              <div class="NavigationReceiptsTitle"><b>My Receipts</b></div> 
              <a id="SortBy" class="SortButton"><b>Sort</b></a>
              <a id="AddReceipt" class="addRButton"><b>+</b></a>
            </div>

            <div class="ItemLabels">
              <div class="ItemLabel"><u>Date</u></div>
              <div class="ItemLabel"><u>Place</u></div>
              <div class="ItemLabel"><u>Amount</u></div>
              <div class="ItemLabel"><u>Payment</u></div>
            </div>
            <div id="ReceiptsHolder" class="ReceiptsHolder">

            </div>

            <div id="AddReceiptMenu" class="AddReceiptMenu">
                <div class="AddReceiptTitle">Add Receipt</div>
                <a id="CloseReceiptAdd" class ="CloseReceiptAdd">X</a>
                <div class="DataEntryHolder">
                  <label for="dateData">Date: </label>
                  <input type="date" id ="dateData" class ="DataEntry"></input>
                </div>

                <div class="DataEntryHolder">
                  <label for="placeData">Place: </label>
                  <input type="text" id ="placeData" class ="DataEntry"></input>
                </div>

                <div class="DataEntryHolder">
                  <label for="amountData">Amount: </label>
                  <input type="text" id ="amountData" class ="DataEntry"></input>
                </div>

                <div class="DataEntryHolder">
                  <label for="paymentData">Payment: </label>
                  <input type="text" id ="paymentData" class ="DataEntry"></input>
                </div>
               
         
                <a id="DoneReceipt" class="SubmitReceiptButton"><b>Submit</b></a>

              
            </div>
          </div>
        </main>
  </body>

  <script>
    

    document.getElementById("AddReceipt").addEventListener("click", async => {
        let Element = document.getElementById("AddReceiptMenu")

        Element.style.display = "block";
    })

    document.getElementById("CloseReceiptAdd").addEventListener("click", async => {
        let Element = document.getElementById("AddReceiptMenu")

        Element.style.display = "none";
    })

    document.getElementById("DropDownIcon").addEventListener("click", async => {
      let Element = document.getElementById("DropDown")

      console.log(Element.style.display)

      if (Element.style.display == "block") {
        Element.style.display = "none"
      } else {
        Element.style.display = "block"
      }
    })

    document.getElementById("SortBy").addEventListener("click", async => {
      SortByDate()
    })

    document.getElementById("DoneReceipt").addEventListener("click", async => {
      let data = {
        date: document.getElementById("dateData").value,
        place: document.getElementById("placeData").value,
        amount: document.getElementById("amountData").value,
        payment: document.getElementById("paymentData").value
      }
      try {     
        document.getElementById("AddReceiptMenu").style.display = "none";
        const response = fetch('/profile', {
          method: 'post',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        SortByDate(false)
        console.log('Completed!', response);
      } catch(err) {
        console.error(`Error: ${err}`);
      }
    })

    //SEND GET REQUEST TO RECEIEVE GOOGLE DATA, SUCH AS ICON
    async function GetOAuthData() {
      const response = await fetch('/oauth', {
            method: 'get',
      });

      response.json()
      .then( data => {
        document.getElementById("UserIconImage").src = data.picture;
      })
    }


    //CONVERTS DATA DATE TO WRITTEN DATE
    function DateToString(date) {
      let year = 0;

      let f_index = 0

      while (date[f_index] != '-') {
        ++f_index;
      }

      year = date.substring(0,f_index)

      let month = date.substring(f_index + 1, f_index + 3)

      let day = date.substring(f_index + 4, f_index + 6)


      return month + '/' + day + '/' + year;
    }

    //FIND FUNCTION FOR ARRAYS
    function arrayfind(array, toFind) {
      console.log(array,toFind);

      for (let q = 0; q < array.length; q++) {
        if (array[q] == toFind) {
          return true
        }
      }

      return false;
    }

    //CONVERTS DATE TYPE TO NUMBER FOR COMPARISON
    function dateToNum(date) {
      let year = 0;

      let f_index = 0

      while (date[f_index] != '-') {
        ++f_index;
      }

      year = Number(date.substring(0,f_index))

      let month = Number(date.substring(f_index + 1, f_index + 3))
      month = month*40

      let day = Number(date.substring(f_index + 4, f_index + 6))


      return day + month + year;
    }

    //SORTS ALL DATA BY DATE
    async function SortByDate(increasing) {
      try {     
          const response = await fetch('/getData', {
            method: 'get',
          });
    

          response.json()
          .then(data => {
            console.log("NEWDATA", data)
            let oldReceiptElements = document.getElementsByClassName("ReceiptItem")


            while (oldReceiptElements[0]) {
              console.log('Removing')
              oldReceiptElements[0].remove()
            }

            document.getElementById('ReceiptsHolder').style.height = (10.5*data.holdata.length) + "vh"


            let SmallestTab = []
            
            for (let i = 0; i < data.holdata.length; ++i) {
              let smallest = 999999
              let smallestIndex = 0

              for (let g = 0; g < data.holdata.length; ++g) {
                console.log(arrayfind(SmallestTab, g), "ARRAYFIND")
                console.log(dateToNum(data.holdata[g].date), "DATETONUM", smallest)
                console.log(data.holdata[g].place, "PLACEHere")
                console.log(g, "GHERE")
                if (arrayfind(SmallestTab, g) == true) {
                  console.log('Found Similiar')
                } else if (dateToNum(data.holdata[g].date) < smallest) {
                  smallest = dateToNum(data.holdata[g].date)
                  smallestIndex = g
                }
              }

              console.log(smallestIndex, "SMALLESTINDEX") 

              SmallestTab.push(smallestIndex)

              let newItem = document.createElement("div")
              newItem.classList.add("ReceiptItem")

              document.getElementById('ReceiptsHolder').append(newItem)

              let dateItem = document.createElement("div")
              dateItem.classList.add("ReceiptChildItem")
              dateItem.innerHTML = "<b>" + DateToString(data.holdata[smallestIndex].date) + "</b>"
              newItem.append(dateItem)

              let placeItem = document.createElement("div")
              placeItem.classList.add("ReceiptChildItem")
              placeItem.innerHTML = "<b>" + data.holdata[smallestIndex].place + "</b>"
              newItem.append(placeItem)
              console.log(data.holdata[smallestIndex].place)

              let amountItem = document.createElement("div")
              amountItem.classList.add("ReceiptChildItem")
              amountItem.innerHTML = "<b>" + "$" + data.holdata[smallestIndex].amount + "</b>"
              newItem.append(amountItem)

              let paymentItem = document.createElement("div")
              paymentItem.classList.add("ReceiptChildItem")
              paymentItem.innerHTML = "<b>" + data.holdata[smallestIndex].payment + "</b>"
              newItem.append(paymentItem)
            }

          })

        
        
        } catch(err) {
          console.error(`Error: ${err}`);
  
        }
    }


    //INITIALLY GET ALL DATES AND GOOGLE DATA

    SortByDate(false)

    GetOAuthData()

  
  </script>

</html>